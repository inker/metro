(window.webpackJsonp=window.webpackJsonp||[]).push([["app"],{1:function(t,e,n){"use strict";n.d(e,"b",(function(){return o})),n.d(e,"a",(function(){return r})),n.d(e,"c",(function(){return i})),n.d(e,"d",(function(){return a}));var s=n(37);function o(t,e){const n=new Set;for(const s of t)e.has(s)&&n.add(s);return n}function r(t,e,n){let o=t.get(e);return void 0===o&&(o=s(n)?n():n,t.set(e,o)),o}function i(t,e){const n=t.get(e);if(void 0===n)throw console.error("in map",t,":",e,"->",n),new Error("key or val is undefined");return n}function a(t,e){const n=t.getKey(e);if(void 0===n)throw console.error("in map",t,":",e,"->",n),new Error("key or val is undefined");return n}},101:function(t,e,n){t.exports={contextmenu:"src-ui-ContextMenu-___styles__contextmenu___3xDNi"}},104:function(t,e,n){t.exports={"plate-box":"src-ui-Tooltip-___styles__plate-box___3nnCx"}},11:function(t,e,n){"use strict";n.d(e,"a",(function(){return c})),n.d(e,"d",(function(){return l})),n.d(e,"b",(function(){return h})),n.d(e,"c",(function(){return u}));var s=n(102),o=n(103),r=n(12),i=n(87);n(4);const a=["paths-inner","paths-outer","transfers-inner","transfers-outer","station-circles"].map(t=>`#${t} > *`).join(", ");function c(){const t=location.search.match(/city=(\w+)/);return t?t[1]:"spb"}function l(){const t=document.querySelectorAll(a);for(const{style:e}of t)e.opacity=null,e.filter="none"}function h(t){const{name:e,altNames:n}=t,s=Object(i.a)(),o=[e];return s&&n[s]&&o.push(n[s]),n.en&&o.push(n.en),o}function u(t){const e=t.map(h);return s(...e).map(t=>o(t).join(" / ")).filter(r)}},112:function(t,e,n){"use strict";n.r(e);n(113);var s=n(0),o=n(92),r=(n(64),n(20));n(224),n(225),n(226);if(s.Browser.ie)throw alert("Does not work in your browser (yet)"),new Error("shitty browser");const i=s.Browser.mobile?Promise.resolve().then(n.bind(null,64)):n.e("EditableMetroMap").then(n.bind(null,227)),a=location.search.match(/city=(\w+)/),c=a?a[1]:"spb";for(const t of Object.keys(r.url))r.url[t]=r.url[t].replace(/\{city\}/g,c);i.then(t=>{new t.default(r)}),document.title=`${c&&"spb"!==c?o(c):"St Petersburg"} metro plan proposal`,document.getElementById("favicon").href=r.favicons[c]},14:function(t,e,n){"use strict";n.d(e,"a",(function(){return s})),n.d(e,"b",(function(){return o})),n.d(e,"c",(function(){return r}));const s=(t,e)=>new Promise(n=>{t.addEventListener(e,(function s(o){t.removeEventListener(e,s),n(o)}))});function o(t){const e=e=>{27===e.keyCode&&(s(),t(e))},n=e=>{s(),t(e)};function s(){removeEventListener("keydown",e,!0),removeEventListener("backbutton",n)}addEventListener("keydown",e,!0),addEventListener("backbutton",n)}const r=t=>s(t,"transitionend")},15:function(t,e,n){"use strict";var s=n(0),o=n(5),r=n(13);class i{constructor(t,e,n={},s="normal",o){this.id=r("platform-"),this.spans=[],this.transfers=[],this.name=t,this.altNames=n,this.location=e,this.type=s,this.elevation=o}get station(){return this._station}passingRoutes(){const t=new Set;for(const e of this.spans)for(const n of e.routes)t.add(n);return t}passingLines(){const t=new Set;for(const e of this.spans)for(const n of e.routes)t.add(n.line);return t}}var a=n(11),c=n(25);class l{constructor(t){this.id=r("station-"),this.platforms=t;for(const e of t)e._station=this}getNames(){return Object(a.c)(this.platforms)}getCenter(){return Object(c.a)(this.platforms.map(t=>t.location))}passingLines(){const t=new Set;for(const e of this.platforms)for(const n of e.spans)for(const e of n.routes)t.add(e.line);return t}}var h=class{constructor(t,e){if(this.id=r("edge-"),t===e)throw new Error(`source is the same as target: ${t}`);this._source=t,this._target=e}get source(){return this._source}set source(t){this._source=t}get target(){return this._target}set target(t){this._target=t}isOf(t,e){return this._source===t&&this._target===e||this._source===e&&this._target===t}has(t){return this._source===t||this._target===t}other(t){if(this._source===t)return this._target;if(this._target===t)return this._source;throw new Error("span does not have vertex")}isAdjacent(t){return this.has(t._source)||this.has(t._target)}isParallel(t){return t.isOf(this._source,this._target)}invert(){const t=this._source;this._source=this._target,this._target=t}};class u extends h{constructor(t,e,n){super(t,e),t.spans.push(this),e.spans.push(this),this.routes=n}get source(){return this._source}set source(t){void 0!==this._source&&o(this._source.spans,this),this._source=t,t.spans.push(this)}get target(){return this._target}set target(t){void 0!==this._target&&o(this._target.spans,this),this._target=t,t.spans.push(this)}}class d extends h{constructor(t,e,n){super(t,e),t.transfers.push(this),e.transfers.push(this),this.type=n}get source(){return this._source}set source(t){void 0!==this._source&&o(this._source.transfers,this),this._source=t,t.transfers.push(this)}get target(){return this._target}set target(t){void 0!==this._target&&o(this._target.transfers,this),this._target=t,t.transfers.push(this)}}n.d(e,"a",(function(){return i})),n.d(e,"b",(function(){return u})),n.d(e,"c",(function(){return d}));e.d=class{constructor(t){this.platforms=t.platforms.map(t=>new i(t.name,(t=>Object(s.latLng)(t.lat,t.lng))(t.location),t.altNames,t.type)),this.stations=[],this.routes=t.routes,this.lines=t.lines,this.transfers=t.transfers.map(t=>new d(this.platforms[t.source],this.platforms[t.target],t.type));const e=t=>t.routes.map(t=>this.routes[t]);this.spans=t.spans.map(t=>new u(this.platforms[t.source],this.platforms[t.target],e(t))),console.time("restore");const n=new Set(this.transfers),o=new Set(this.platforms);for(;n.size>0;){const t=n.values().next().value,e=new Set([t.source,t.target]);n.delete(t);for(const t of e){const s=new Set;for(const o of n)o.source===t?(e.add(o.target),s.add(o)):o.target===t&&(e.add(o.source),s.add(o));for(const t of s)n.delete(t);o.delete(t)}const s=new l(Array.from(e));this.stations.push(s)}for(const t of o)this.stations.push(new l([t]));console.timeEnd("restore")}toJSON(){const{platforms:t,transfers:e,lines:n,spans:s,routes:o}=this;return JSON.stringify({graphVersion:"1.1",platforms:t.map(t=>({name:t.name,altNames:t.altNames,location:t.location,type:"normal"===t.type?void 0:t.type})),transfers:e.map(e=>({type:e.type,source:t.indexOf(e.source),target:t.indexOf(e.target)})),lines:n,spans:s.map(e=>({source:t.indexOf(e.source),target:t.indexOf(e.target),routes:e.routes.map(t=>o.indexOf(t))})),routes:o},(t,e)=>t.startsWith("_")?void 0:e,2)}deletePlatform(t){console.log("removing platform",t);const{transfers:e,spans:n,station:s}=t;for(const t of e)o(this.transfers,t);if(e.length=0,1===n.length){const e=n[0],s=e.other(t);o(s.spans,e),o(this.spans,e)}else if(2===n.length){const[e,s]=n,r=s.other(t);if(!r)throw new Error("span does not have other end");if(2===t.passingRoutes().size){const n=e.other(t);o(n.spans,e),o(this.spans,e)}else e.source===t?e.source=r:e.target=r;o(r.spans,s),o(this.spans,s)}else for(const e of n){const n=e.other(t);o(n.spans,e),o(this.spans,e)}1===s.platforms.length?o(this.stations,s):o(s.platforms,t),o(this.platforms,t)}}},2:function(t,e,n){"use strict";var s=n(0),o=n(4),r=n(7);function i(t,e,n,s){const{radius:i,large:a,clockwise:c}=function(t,e,n){const s=Object(r.a)([t,e,n]);if(null===s)return{radius:1/0};const i=t.subtract(n),a=e.subtract(n),c=Object(o.d)(i,a)<0,l=t.subtract(s),h=e.subtract(s),u=Object(o.c)(l,h)>=0;return{radius:s.distanceTo(t),large:c?1:0,clockwise:u&&!c||c&&!u?1:0}}(e,n,s),l=["M",e.x,e.y,...i===1/0?["L"]:["A",i,i,0,a,c],n.x,n.y].join(" ");t.setAttribute("d",l)}n.d(e,"a",(function(){return a})),n.d(e,"d",(function(){return c})),n.d(e,"c",(function(){return l})),n.d(e,"e",(function(){return u})),n.d(e,"f",(function(){return d})),n.d(e,"g",(function(){return f})),n.d(e,"b",(function(){return p}));const a=t=>document.createElementNS("http://www.w3.org/2000/svg",t);function c(t){const e=a("polygon"),n=t.map(t=>`${t.x},${t.y}`).join(" ");return e.setAttribute("points",n),e}function l(t,e){const n=a("circle");return n.setAttribute("r",e.toString()),n.setAttribute("cy",t.y.toString()),n.setAttribute("cx",t.x.toString()),n.style.transformOrigin=`${t.x}px ${t.y}px`,n}function h(t,e){const n=a("line");return n.setAttribute("x1",t.x.toString()),n.setAttribute("y1",t.y.toString()),n.setAttribute("x2",e.x.toString()),n.setAttribute("y2",e.y.toString()),n}function u(t,e,n){const s=a("rect");s.setAttribute("x",(t.x-.5*e-n).toString()),s.setAttribute("y",(t.y-n).toString());const o=2*n;return s.setAttribute("width",(e+o).toString()),s.setAttribute("height",o.toString()),s.setAttribute("rx",n.toString()),s.setAttribute("ry",n.toString()),s.style.transformOrigin=`${t.x}px ${t.y}px`,s}function d(t,e,n){const s=function(t,e,n){const s=a("path");return i(s,t,e,n),s}(t,e,n),o=s.cloneNode(!0);return[s,o]}function f(t,e){const n=e.clone();return t.x===e.x?n.x+=.01:t.y===e.y&&(n.y+=.01),[h(t,n),h(t,n)]}const p=t=>t instanceof SVGRectElement?function(t){const e=+t.getAttribute("x")+ +t.getAttribute("width")/2,n=+t.getAttribute("y")+ +t.getAttribute("height")/2,o=Object(s.point)(e,n),r=~~+t.getAttribute("rx"),i=Object(s.point)(0+r,4+r);return o.subtract(i)}(t):function(t){const e=t.getAttribute("cx"),n=t.getAttribute("cy"),o=t.getAttribute("r");if(null===e||null===n||null===o)throw new Error("cx, cy or r does not exist on a circle");const r=Object(s.point)(+e,+n),i=~~o,a=Object(s.point)(0+i,4+i);return r.subtract(a)}(t)},20:function(t){t.exports=JSON.parse('{"containerId":"map-container","minZoom":7,"maxZoom":18,"zoom":11,"detailedZoom":12,"url":{"graph":"https://raw.githubusercontent.com/metrofan/metronetworks/master/{city}/graph.json","data":"res/faq.json","scheme":"https://cdn.jsdelivr.net/gh/metrofan/metronetworks@latest/{city}/scheme.css"},"favicons":{"spb":"https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Spb_metro_logo.svg/293px-Spb_metro_logo.svg.png","moscow":"https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/%D0%9B%D0%BE%D0%B3%D0%BE%D1%82%D0%B8%D0%BF_%D0%BC%D0%B5%D1%82%D1%80%D0%BE_%D0%B2_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B5_%D0%B1%D1%80%D0%B5%D0%BD%D0%B4%D0%B0_%D0%BC%D0%BE%D1%81%D0%BA%D0%BE%D0%B2%D1%81%D0%BA%D0%BE%D0%B3%D0%BE_%D1%82%D1%80%D0%B0%D0%BD%D1%81%D0%BF%D0%BE%D1%80%D1%82%D0%B0.svg/199px-%D0%9B%D0%BE%D0%B3%D0%BE%D1%82%D0%B8%D0%BF_%D0%BC%D0%B5%D1%82%D1%80%D0%BE_%D0%B2_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B5_%D0%B1%D1%80%D0%B5%D0%BD%D0%B4%D0%B0_%D0%BC%D0%BE%D1%81%D0%BA%D0%BE%D0%B2%D1%81%D0%BA%D0%BE%D0%B3%D0%BE_%D1%82%D1%80%D0%B0%D0%BD%D1%81%D0%BF%D0%BE%D1%80%D1%82%D0%B0.svg.png","helsinki":"https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Helsinki_metro_logo_round_edges.svg/240px-Helsinki_metro_logo_round_edges.svg.png","tallinn":"","stockholm":"https://upload.wikimedia.org/wikipedia/commons/thumb/4/46/Stockholm_metro_symbol.svg/240px-Stockholm_metro_symbol.svg.png","qazan":"https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Kazan-metro-Logo.svg/240px-Kazan-metro-Logo.svg.png","praha":"https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Prag_Metro_Logo.svg/320px-Prag_Metro_Logo.svg.png"}}')},224:function(t,e,n){},225:function(t,e,n){},226:function(t,e,n){},25:function(t,e,n){"use strict";var s=n(0),o=n(58);e.a=t=>Object(s.latLng)(o(t,t=>t.lat),o(t,t=>t.lng))},26:function(t,e,n){t.exports={"faq-card":"src-ui-FAQ-___styles__faq-card___1z_bu","cross-ball":"src-ui-FAQ-___styles__cross-ball___1S1oV",question:"src-ui-FAQ-___styles__question___3-nHI",answer:"src-ui-FAQ-___styles__answer___HnLTe"}},3:function(t,e,n){"use strict";var s=n(40);const o={platformBindings:new WeakMap,dummyBindings:new s.WeakBiMap,outerEdgeBindings:new s.WeakBiMap,innerEdgeBindings:new s.WeakBiMap,gradientBindings:new WeakMap};e.a=Object.freeze(o)},4:function(t,e,n){"use strict";n.d(e,"j",(function(){return i})),n.d(e,"i",(function(){return c})),n.d(e,"f",(function(){return l})),n.d(e,"d",(function(){return h})),n.d(e,"c",(function(){return u})),n.d(e,"g",(function(){return d})),n.d(e,"a",(function(){return f})),n.d(e,"h",(function(){return p})),n.d(e,"b",(function(){return m})),n.d(e,"e",(function(){return g}));var s,o=n(0),r=n(7);!function(t){t[t.COLLINEAR=0]="COLLINEAR",t[t.CLOCKWISE=1]="CLOCKWISE",t[t.ANTICLOCKWISE=2]="ANTICLOCKWISE"}(s||(s={}));Object.freeze(Object(o.point)(0,0));const i=Object.freeze(Object(o.point)(1,0)),a=t=>Object(r.b)(t.x)&&Object(r.b)(t.y),c=(t,e)=>Object(o.point)(+t.x.toFixed(e),+t.y.toFixed(e)),l=t=>t.reduce((t,e)=>t.add(e)).divideBy(t.length),h=(t,e)=>t.x*e.x+t.y*e.y,u=(t,e)=>t.x*e.y-e.x*t.y,d=t=>t.divideBy((t=>Math.sqrt(h(t,t)))(t)),f=(t,e)=>h(t,e)/t.distanceTo(e),p=t=>[Object(o.point)(t.y,-t.x),Object(o.point)(-t.y,t.x)];function m(t,e){const n=d(t),s=d(e),r=n.add(s);return a(r)?Object(o.point)(0,0):d(r)}function g([t,e],[n,s]){const o=u(e,s);if(Math.abs(o)<Number.EPSILON)return null;const r=n.subtract(t),i=u(r,s)/o;return e.multiplyBy(i).add(t)}},6:function(t,e,n){"use strict";n.d(e,"b",(function(){return o})),n.d(e,"d",(function(){return r})),n.d(e,"a",(function(){return i})),n.d(e,"c",(function(){return l})),n.d(e,"e",(function(){return u}));n(39),n(12);var s=n(1);const o=(t,e,n=!1)=>`<a href="${t}" ${n?'target="_blank" rel="noopener"':""}>${e}</a>`;function r(t){let e;for(;e=t.firstChild;)t.removeChild(e)}function i(t){const e=document.getElementById(t);if(!e)throw new Error(`no element with id=${t} exists`);return e}const a=new WeakMap;function c(t,e,n){const o=t.getAttribute(e);if(null===o){if("function"==typeof n)throw new Error("cannot invoke on null");return void t.setAttribute(e,n)}if(Object(s.a)(a,t,{})[e]=o,"string"==typeof n)return void t.setAttribute(e,n);const r=n(o);t.setAttribute(e,r)}function l(t,e){const{attributes:n}=t,s={};for(let t=0,e=n.length;t<e;++t){const{name:e,value:o}=n[t];s[e]=o}const o=e(s);for(const[e,n]of Object.entries(o))c(t,e,n)}function h(t,e){const n=a.get(t);if(void 0===n)return;const s=n[e];void 0!==s&&(n[e]=void 0,t.setAttribute(e,s))}function u(t,...e){for(const n of e)h(t,n)}},64:function(t,e,n){"use strict";n.r(e);var s=n(0),o=n.n(s),r=n(109),i=n(93),a=n(94),c=n(13),l=n(95);var h=n(57)((function(t,e){const n=t>9?t:t>8?9.5:9,s=.5*(n-7),o=n<e?1.25*s:1.1*s,r=n<e?.4*o:.6*o;return{lineWidth:s,lightLineWidth:.75*s,circleRadius:o,circleBorder:r,dummyCircleRadius:2*o,transferWidth:.9*s,transferBorder:1.4*r,fullCircleRadius:o+r/2}}),(...t)=>t.join(":")),u=n(9),d=n(14),f=n(38),p=n(2);const m=100..toString();var g=t=>{const e=Object(p.a)("svg");e.setAttribute("width",m),e.setAttribute("height",m);const n=Object(p.c)(Object(s.point)(50,50),40),{style:o}=n;o.stroke="red",o.strokeWidth="20px",o.fill="white",e.appendChild(n);const r=2*t;return Object(s.icon)({iconUrl:Object(f.svgToDataUrl)(e),iconSize:[r,r],iconAnchor:[t,t],popupAnchor:[0,-t]})},b=n(97),y=n.n(b);class w{constructor(){this.polyline=o.a.polyline([],{color:"red"}),this.markers=o.a.featureGroup(),this.dashedLine=o.a.polyline([],{color:"red",opacity:.5,dashArray:"0,9",className:y.a["dashed-line"]}),this.showDashedLine=()=>{this.dashedLine.setStyle({opacity:.5})},this.hideDashedLine=()=>{this.dashedLine.setStyle({opacity:0})},this.handleDrag=()=>{this.dashedLine.setStyle({opacity:0}),this.updateDistances()},this.onCircleClick=t=>{0===t.originalEvent.button&&(this.markers.removeLayer(t.target),0!==this.markers.getLayers().length?(this.updateDistances(),this.map.hasLayer(this.dashedLine)||this.showDashedLine()):this.fireClearMeasurements())},this.makeMarker=t=>{if(0!==t.originalEvent.button)return;const e=o.a.marker(t.latlng,{draggable:!0}).setIcon(g(5)).bindPopup("").on("mouseover",this.hideDashedLine).on("mouseout",this.showDashedLine).on("drag",this.handleDrag).on("click",this.onCircleClick);this.markers.addLayer(e),this.updateDistances()},this.resetDashedLine=t=>{const e=this.dashedLine.getLatLngs();e[1]=t.latlng,this.dashedLine.setLatLngs(e),this.dashedLine.redraw()},this.fireClearMeasurements=()=>{this.map.fire("clearmeasurements")},this.clearMeasurements=()=>{this.map.getPanes().overlayPane.style.zIndex="-1000",this.map.removeLayer(this.polyline).removeLayer(this.markers.clearLayers()).removeLayer(this.dashedLine).off("mousemove",this.resetDashedLine).off("click",this.makeMarker)}}onAdd(t){return this.map=t,t.fireEvent("distancemeasureinit"),t.on("measuredistance",e=>this.measureDistance(t.mouseEventToLatLng(e))),t.on("clearmeasurements",this.clearMeasurements),this}onRemove(t){}addTo(t){return this.onAdd(t),this}updateDistances(){const t=this.polyline.getLatLngs(),e=this.markers.getLayers(),n=e.length;t[0]=e[0].setPopupContent("0").getLatLng();for(let s=1,o=0;s<n;++s){const n=e[s].getLatLng();t[s]=n,o+=e[s-1].getLatLng().distanceTo(n);const r=Math.round(o),i=r<1e3?`${r} m`:`${r<1e4?r/1e3:Math.round(r/10)/100} km`,a=e[s];a.setPopupContent(i);const c=a.getPopup();if(!c)throw new Error("no popup exists for some reason");c.options.closeButton=!1}t.length>n&&(t.length=n);const s=this.dashedLine.getLatLngs();s[0]=u(t),this.dashedLine.setLatLngs(s),this.polyline.setLatLngs(t),this.polyline.redraw(),this.openLastMarkerPopup()}openLastMarkerPopup(){const t=this.markers.getLayers();if(t.length<2)return;const e=u(t);e&&e instanceof o.a.Marker&&e.openPopup()}measureDistance(t){this.map.getPanes().overlayPane.style.zIndex="",this.map.addLayer(this.polyline.setLatLngs([])).addLayer(this.markers).addLayer(this.dashedLine.setLatLngs([])).on("click",this.makeMarker).on("mousemove",this.resetDashedLine).fire("click",{latlng:t,originalEvent:{button:0}}),Object(d.b)(this.fireClearMeasurements)}}var v=n(98),O=n.n(v),k=n(56);const L="http://www.w3.org/1999/xhtml",j="http://www.w3.org/2000/svg";var x=n(99),_=n.n(x),B=n(100),E=n(6),M=n(101),C=n.n(M);class D{constructor(t){this.handler=t=>{const{target:e}=t;console.log("target",e,e.parentNode);const{className:n}=e;if(!e||"string"==typeof n&&n.includes("leaflet-control"))return;t.preventDefault(),Object(E.d)(this.container);for(const t of this.items){if(t.trigger&&!t.trigger(e)){console.log(t.trigger(e));continue}const n=document.createElement("div");t.extra&&t.extra.disabled?n.setAttribute("disabled",""):n.setAttribute("data-event",t.event),n.textContent=t.text,this.container.appendChild(n)}this.container.onclick=e=>{const n=e.target.getAttribute("data-event");n&&(this.hide(),this.map.fireEvent(n,{clientX:a,clientY:c,relatedTarget:t.target}))};const{width:s,height:o}=this.container.getBoundingClientRect(),{clientWidth:r,clientHeight:i}=document.documentElement,{clientX:a,clientY:c}=t,l=a+s>r?r-s:a,h=c+o>i?c-o:c;this.container.style.transform=`translate(${l}px, ${h}px)`,this.show()},this.show=()=>{this.container.style.visibility="visible",s.Browser.mobile&&this.map.dragging.disable()},this.hide=()=>{this.container.style.visibility="hidden",s.Browser.mobile&&this.map.dragging.enable()},this.items=t,this.container=document.createElement("div"),this.container.classList.add(C.a.contextmenu),this.container.addEventListener("contextmenu",t=>{t.preventDefault(),t.target.click()})}addTo(t){return this.onAdd(t),this}onAdd(t){if(this.map=t,void 0===t)throw new Error("cannot add map editor to metro map: leaflet map is missing");const e=t.getContainer();e.addEventListener("contextmenu",this.handler),e.addEventListener("mousedown",this.hide),e.addEventListener("touchstart",this.hide),s.Browser.mobile||t.on("movestart",this.hide),document.body.appendChild(this.container)}onRemove(t){}insertItem(t,e,n,s,o){const r={event:t,text:e,trigger:n,extra:s};void 0===o||o<0?this.items.push(r):this.items.splice(o,0,r)}removeItem(t,e=!1){if(e)return void B(this.items,e=>e.event===t);const n=this.items.findIndex(e=>e.event===t);n<0||this.items.splice(n,1)}}var S=n(11);function A(t,e,n){const s=e*e/n;return s<t?e/n*2+(t-s)/e:2*Math.sqrt(t/n)}var $=n(1);const P=(t,e)=>s.LatLng.prototype.distanceTo.call(t,e);var T=(t,e,n)=>{const s=new Map,o=new Map;for(const r of t){const t=r.spans.some(t=>t.routes[0].line.startsWith("E"));let i=P(e,r.location),a=i/1;const c=t?360:240;s.set(r,a+c),a=(i=P(r.location,n))/1,"dummy"!==r.type&&o.set(r,a)}let r=((t,e)=>{const{length:n}=e;if(n<1)throw new Error("an objects array must contain at least 1 object");let s=e[0];const o=t=>t.location||t;let r=t.distanceTo(o(s));for(let i=1;i<n;++i){const n=e[i],a=t.distanceTo(o(n));a<r&&(s=n,r=a)}return s})(e,t);const i=new Set(t),a=new Map;for(;i.size>0;){let t=1/0;for(const e of i){const n=Object($.c)(s,e);n<t&&(r=e,t=n)}i.delete(r);const e=[],n=[];for(const t of r.spans){const s=t.other(r);if(!i.has(s))continue;e.push(s);const o=P(r.location,s.location);let a=0;const c=t.routes[0].line.startsWith("E")?40:25,l=A(o,20,.7);n.push(l+c+a)}for(const t of r.station.platforms){if(!i.has(t))continue;e.push(t);const s=t.spans.some(t=>t.routes[0].line.startsWith("E")),o=P(r.location,t.location)/2;n.push(o/1+(s?360:240))}for(let t=0,o=e.length;t<o;++t){const o=e[t],i=Object($.c)(s,r)+n[t];i<Object($.c)(s,o)&&(s.set(o,i),a.set(o,r))}}let c=1/0;for(const[t]of s){if("dummy"===t.type)continue;const e=Object($.c)(s,t)+Object($.c)(o,t);e<c&&(c=e,r=t)}const l=P(e,n)/1;if(l<c)return{time:{walkTo:l}};const h=[],d=[r];for(let t=a.get(r);void 0!==t&&void 0!==t;t=a.get(r)){let e;for(const n of r.spans)if(n.has(t)){e=n;break}if(void 0===e)for(const n of r.transfers)if(n.has(t)){e=n;break}if(void 0===e){const{transfers:e,midPlatforms:n}=z(t,r);h.push(...e.reverse()),d.push(...n)}else h.push(e);d.push(t),r=t}d.reverse(),h.reverse();const f=Object($.c)(o,u(d)),p=Object($.c)(s,d[0]);return{platforms:d,edges:h,time:{walkTo:p,metro:c-f-p,walkFrom:f,total:c}}};function z(t,e){if(t.station!==e.station)throw new Error(`platforms (${t.name} & ${e.name} must be on the same station`);const{platforms:n}=t.station,s=new Set(n),o=new Map,r=new Map;for(const t of n)o.set(t,1/0);o.set(t,0);let i=t;for(;s.size>0;){let t=1/0;for(const e of s){const n=Object($.c)(o,e);n<t&&(i=e,t=n)}s.delete(i);const e=i.transfers.map(t=>t.other(i));for(const t of e){if(!t||!s.has(t))continue;const e=P(i.location,t.location),n=Object($.c)(o,i)+e;n<Object($.c)(o,t)&&(o.set(t,n),r.set(t,i))}}const a=[],c=[];for(i=e;;){const t=r.get(i);if(!t)break;const e=i.transfers.find(e=>e.has(t));e?(a.push(e),i=t,c.push(i)):console.error("cannot find transfer node")}return c.pop(),{transfers:a.reverse(),midPlatforms:c.reverse()}}const N="black-glow";function W(t){t.appendChild(function(){const t=Object(p.a)("filter");return t.id="shadow",t.setAttribute("width","200%"),t.setAttribute("height","200%"),t.innerHTML='\n        <feOffset\n            result="offOut"\n            in="SourceAlpha"\n            dx="0"\n            dy="4"\n        />\n        <feColorMatrix\n            result="matrixOut"\n            in="offOut"\n            type="matrix"\n            values="\n                0 0 0 0   0\n                0 0 0 0   0\n                0 0 0 0   0\n                0 0 0 0.5 0\n            "\n        />\n        <feGaussianBlur\n            result="blurOut"\n            in="matrixOut"\n            stdDeviation="2"\n        />\n        <feBlend\n            in="SourceGraphic"\n            in2="blurOut"\n            mode="normal"\n        />\n    ',t}()),t.appendChild(function(){const t=Object(p.a)("filter");return t.id=N,t.innerHTML='\n        <feColorMatrix\n            type="matrix"\n            values="\n                0 0 0 0   0\n                0 0 0 0   0\n                0 0 0 0   0\n                0 0 0 0.3 0\n            "\n        />\n        <feGaussianBlur\n            stdDeviation="2.5"\n            result="coloredBlur"\n        />\n        <feMerge>\n            <feMergeNode in="coloredBlur"/>\n            <feMergeNode in="SourceGraphic"/>\n        </feMerge>\n    ',t}()),t.appendChild(function(){const t=Object(p.a)("filter");return t.id="opacity",t.innerHTML='\n        <feComponentTransfer>\n            <feFuncA type="table" tableValues="0 0.5">\n        </feComponentTransfer>\n    ',t}()),t.appendChild(function(){const t=Object(p.a)("filter");return t.id="gray",t.innerHTML='\n        <feColorMatrix\n            type="matrix"\n            values="\n                0.2126 0.7152 0.0722 0 0\n                0.2126 0.7152 0.0722 0 0\n                0.2126 0.7152 0.0722 0 0\n                0 0 0 1 0\n            "\n        />\n    ',t}())}function I(t){const e=t.getBoundingClientRect(),n=getComputedStyle(t),s=2*parseFloat(n.strokeWidth||t.style.strokeWidth||"0");e.height>=s&&e.width>=s&&(t.style.filter=`url(#${N})`)}const R=(t,e)=>0===t?"":`${t}${t>1?`${e}s`:e}`;var F=t=>{if(void 0===t)return"";if(t<60)return`${Math.round(t)} seconds`;if(t<3570){const e=Math.round(t/60);return R(e,"min")}const e=Math.floor(t/3600),n=Math.floor((t-3600*e)/60);return`${e>0?`${e}h`:""} ${R(n,"min")}`},G=n(15),V=n(3),Z=n(59),q=n.n(Z);const H=new Set,Q=new Set,U=new Set;function K(t,e,n=!1){n?t instanceof SVGCircleElement?function(t,e){H.add(t),Object(E.c)(t,({r:t})=>({r:(+t*e).toString()}))}(t,e):t instanceof SVGRectElement&&function(t,e){Q.add(t),Object(E.c)(t,({x:t,y:n,width:s,height:o,rx:r,ry:i})=>{const a=+o*(e-1),c=a/2;return{x:(+t-c).toString(),y:(+n-c).toString(),width:(+s+a).toString(),height:(+o*e).toString(),rx:(+r*e).toString(),ry:(+i*e).toString()}})}(t,e):t.style.transform=`scale(${e})`}function J(t,e){const n=parseFloat(Object(E.a)("transfers-outer").style.strokeWidth||""),s=parseFloat(Object(E.a)("transfers-inner").style.strokeWidth||""),o=Object($.c)(V.a.outerEdgeBindings,t),r=Object($.c)(V.a.innerEdgeBindings,t);o.style.strokeDasharray||(U.add(o),o.style.strokeWidth=n*e+"px"),r.style.strokeDasharray||(U.add(r),r.style.strokeWidth=s*e+"px")}const Y=s.Browser.webkit&&!s.Browser.mobile;let X=!0,tt=null;const et=1,nt=.25,st=1.5,ot=3,rt=200;function it(){return null===tt?Promise.resolve(!0):(X=!1,tt)}function at(t,e){return tt=async function(t,e){const n=e.length,s=document.getElementById("transfers-outer");for(let o=0;o<n;++o){if(!X)return!1;const n=Object($.c)(V.a.platformBindings,t[o]);n.style.opacity=null,Y&&ct(n,st,rt);const r=e[o],i=r instanceof G.c,a=V.a.outerEdgeBindings.get(e[o]);if(!a||i&&("osi"===r.type||a.parentNode!==s))continue;const c=V.a.innerEdgeBindings.get(e[o]),l=a.cloneNode(!0),h=void 0===c?void 0:c.cloneNode(!0),u=Object(E.a)("paths-outer");u.appendChild(l);const d=Object(E.a)("paths-inner");h&&d.appendChild(h),I(l);const f=i?nt:et,p=r.source!==t[o],m=[q()(l,f,p)];h&&m.push(q()(h,f,p)),await Promise.all(m),a.style.opacity=null,I(a),u.removeChild(l),c&&(c.style.opacity=null),h&&d.removeChild(h)}const o=Object($.c)(V.a.platformBindings,u(t));return o.style.opacity=null,Y&&ct(o,ot,rt),!0}(t,e).then(t=>(tt=null,X=!0,t))}async function ct(t,e,n){const{style:s}=t;s.transition=`transform ${n/2}ms linear`,t.getBoundingClientRect(),K(t,e),await Object(d.c)(t),s.transform="scale(1)",await Object(d.c)(t),s.transition="",s.transform="none"}const lt=n.e("alertify").then(n.bind(null,287)),ht=["paths-inner","paths-outer","transfers-inner","transfers-outer","station-circles"].map(t=>`#${t} *`).join(", ");async function ut(t,e=!0){const{platforms:n=[],edges:s,time:o}=t,r=F(o.walkTo),i=(await lt).default;if(void 0===s)return i.success(`${r} on foot!`);await it();for(const{style:t}of document.querySelectorAll(ht))t.filter="initial",t.opacity="0.25";if(!e)return function(t){for(const e of t){if(e instanceof G.c&&"osi"===e.type)continue;const t=V.a.outerEdgeBindings.get(e);if(void 0===t)continue;t.style.opacity=null;const n=V.a.innerEdgeBindings.get(e);void 0!==n&&(n.style.opacity=null),e instanceof G.b&&I(t)}}(s),void function(t){for(const e of t){const t=V.a.platformBindings.get(e);t&&(t.style.opacity=null)}}(n);if(await at(n,s)){const t=["TIME",`${r} on foot`,`${F(o.metro)} by metro`,`${F(o.walkFrom)} on foot`,`TOTAL: ${F(o.total)}`];i.message(t.join("<br>"),10)}}var dt=(t,e)=>{const n=Object(p.a)("svg");n.setAttribute("width","20"),n.setAttribute("height","30");const o=Object(s.point)(3,12),r=Object(s.point)(10,29),i=Object(s.point)(17,12),a=Object(p.d)([r,o,i]);a.style.fill=t;const c=Object(p.c)(Object(s.point)(10,10),9);if(c.style.fill=t,n.appendChild(a),n.appendChild(c),e){const t=function(t){const e=Object(p.a)("text");e.setAttribute("x","10"),e.setAttribute("y","14");const{style:n}=e;return n.fill="#fff",n.opacity="1",n.textAnchor="middle",n.fontFamily="Corbel, Verdana, Ubuntu",n.fontSize="12px",e.textContent=t,e}(e);n.appendChild(t)}return Object(s.icon)({iconUrl:Object(f.svgToDataUrl)(n),iconAnchor:r,popupAnchor:o.add(i).divideBy(2)})};const ft=n.e("alertify").then(n.bind(null,287));var pt=n(104),mt=n.n(pt);class gt{constructor(){this.element=Object(p.a)("g"),this._disabled=!1,this._editable=!1;const{element:t}=this;t.style.display="none",t.innerHTML=`\n            <foreignObject\n                x="0"\n                y="0"\n                width="100%"\n                height="100%"\n            >\n                <div class=${mt.a["plate-box"]} />\n            </foreignObject>\n        `}get disabled(){return this._disabled}set disabled(t){if(t)this.hide();else{const t=getSelection();t&&t.removeAllRanges()}this._disabled=t}get editable(){return this._editable}set editable(t){const e=t?"true":"false",n=this.element.childNodes[1].children[1].children;for(const t of n)t.contentEditable=e}setFontSize(t){this.element.firstElementChild.firstElementChild.style.fontSize=`${t}px`}show(t,e){if(this.disabled||"none"!==this.element.style.display)return;const n=this.element.firstElementChild,s=n.firstElementChild;s.innerHTML=e.join("<br>"),this.element.setAttribute("transform",`translate(${t.x}, ${t.y})`),this.element.style.display="initial";const{width:o,height:r}=s.getBoundingClientRect();n.setAttribute("transform",`translate(${-o}, ${-r})`)}hide(){this.element.style.display="none"}}var bt=n(26),yt=n.n(bt);const wt=/\[\[(.+?)\|(.*?)\]\]/g,vt='<a href="$1" target="_blank" rel="noopener">$2</a>',Ot=t=>`\n    <div>\n        <span class="${yt.a.question}">${t.q}</span>\n        <span class="${yt.a.answer}">${t.a}</span>\n    </div>\n`;class kt{constructor(t){this.showFAQ=()=>{const{card:t,map:e,button:n}=this,{style:o}=t;o.display="inline",o.transform="scale(0.1)",o.opacity="0",t.getBoundingClientRect(),o.transform="none",o.opacity=null,n.disabled=!0,s.Browser.mobile||(e.getContainer().classList.add("dimmed"),e.once("mousedown",t=>this.hideFAQ()),Object(d.a)(window,"keydown").then(t=>{27===t.keyCode&&e.fireEvent("mousedown")}))},this.hideFAQ=()=>{const{card:t,map:e,button:n}=this,{style:o}=t;t.getBoundingClientRect(),o.transform="scale(0.1)",o.opacity="0",s.Browser.mobile||e.getContainer().classList.remove("dimmed"),Object(d.c)(t).then(t=>{o.display="initial"}),n.disabled=!1};const e=document.createElement("button");e.textContent="FAQ",e.classList.add("leaflet-control"),e.classList.add(yt.a["faq-button"]),e.addEventListener("click",this.showFAQ),this.button=e,this.card=document.createElement("div"),this.card.classList.add(yt.a["faq-card"]),s.Browser.mobile&&n.e("hammer").then(n.t.bind(null,285,7)).then(t=>{new t.default(this.card).on("swipeleft swiperight",this.hideFAQ)}),this.card.innerHTML+=t.map(Ot).join("").replace(wt,vt)}addTo(t){this.map=t;const e=document.querySelector(".leaflet-right.leaflet-top");if(document.body.appendChild(this.card),!e)throw new Error("cannot append to .leaflet-right.leaflet-top");return e.appendChild(this.button),this}}const Lt=s.Browser.retina&&!s.Browser.mobile,jt=Object(s.tileLayer)(`https://{s}.tiles.mapbox.com/v3/inker.mlo91c41/{z}/{x}/{y}${Lt?"@2x":""}.png`,{detectRetina:Lt,attribution:'Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://mapbox.com">Mapbox</a>'}),xt=Object(s.tileLayer)("https://api.mapbox.com/styles/v1/inker/cj9cri11x6cqg2slbyi3o3niq/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiaW5rZXIiLCJhIjoiajlpYVl1YyJ9.UpoLm3kdL8SCR6GeCRzyIQ",{detectRetina:Lt,attribution:'Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://mapbox.com">Mapbox</a>'}),_t=Object(s.tileLayer)("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),Bt=Object(s.tileLayer)("http://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png",{attribution:'&copy; Openstreetmap France | &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),Et=Object(s.tileLayer)("http://korona.geog.uni-heidelberg.de/tiles/roads/x={x}&y={y}&z={z}",{attribution:'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),Mt=(Object(s.tileLayer)("https://{s}.tile.openstreetmap.se/hydda/base/{z}/{x}/{y}.png",{attribution:'Tiles courtesy of <a href="http://openstreetmap.se/" target="_blank" rel="noopener">OpenStreetMap Sweden</a> &mdash; Map data &copy; <a href="http://server.ts.openstreetmap.org/copyright">OpenStreetMap</a>'}),Object(s.tileLayer)("https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ"}),Object(s.tileLayer)("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'}),Object(s.tileLayer)("http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'})),Ct=Object(s.tileLayer)("http://i{hash}.wikimapia.org/?x={x}&y={y}&zoom={z}",{hash:t=>t.x%4+t.y%4*4});var Dt=n(7);const St=Date.now(),At=t=>fetch(`${t}?${St}`),$t=t=>At(t).then(t=>t.json());var Pt=n(25),Tt=n(105),zt=n(106),Nt=n(107),Wt=n(108);function It(t){let e=t.match(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i);if(e)return e.slice(1).map(Number);if(!t.startsWith("#"))throw new Error(`invalid css color: ${t}`);if(7===t.length?e=t.match(/[0-9a-f]{2}/gi):4===t.length&&(e=t.slice(1).split("").map(t=>t+t)),!e)throw new Error(`invalid css color: ${t}`);return e.map(t=>parseInt(t,16))}function Rt(t){const e=t.map(It);return`#${Wt(e,(...t)=>Tt(t)).map(t=>Nt(zt(t).toString(16),2,"0")).join("")}`}var Ft=n(60);var Gt=(t,e)=>{const{platforms:n}=e;if(n.length<3)return[];const{transfers:s}=t;if(3===n.length){return n.every(t=>2===((t,e)=>t.filter(t=>t.has(e)))(s,t).length)?n:[]}if(4===n.length){const t=n.map(t=>({platform:t,degree:s.filter(e=>e.has(t)).length})).sort((t,e)=>t.degree-e.degree),e=t.map(t=>t.degree),o=t.map(t=>t.platform);if(Ft(e,[2,2,3,3]))return o;if(Ft(e,[1,2,2,3]))return o.slice(1)}return[]};function Vt(t,e,n=0){const s=function(t){const e=Object(p.a)("linearGradient");return e.innerHTML=t.map(t=>`\n        <stop style="stop-color:${t}" />\n    `).join(""),e}(e);return qt(s,n),Zt(s,t),s}function Zt(t,e){const n=`rotate(${180*Math.atan2(e.y,e.x)/Math.PI}, 0.5, 0.5)`;t.setAttribute("gradientTransform",n)}function qt(t,e){t.firstElementChild.setAttribute("offset",e.toString()),t.lastElementChild.setAttribute("offset",(1-e).toString())}var Ht=n(91),Qt=n(4),Ut=(n(223),n(39));function Kt(t,e){const{stroke:n}=e.style;if(!n)return;const s=n.match(/\bvar\((.+?)\)/);if(!s||!s[1])return;const o=t.get(s[1]);o&&(e.style.stroke=o)}var Jt=async t=>{const e=async function(){const t=await At("res/colors.css"),e=await t.text(),n=/(--[\w-]+?):\s*?(\S.+?);/g,s=[];let o;for(;null!==(o=n.exec(e));)s.push([o[1],o[2]]);return new Map(s)}(),n=function(t){const e=document.createElement("link");return e.rel="stylesheet",e.crossOrigin="",e.href=t,e}(t);document.head.appendChild(n);const s=new Map,o=await e,r=await Object(Ut.tryCall)(()=>n.sheet.cssRules,{interval:100,numAttempts:100});for(const t of r){if(!(t instanceof CSSStyleRule))continue;const e=t.selectorText.split(",").map(t=>t.trim());for(const n of e){const e=n.match(/^.(M\d+|L|E)$/);e&&e[1]&&(Kt(o,t),s.set(e[1],t.style))}}return console.log(s),s};const Yt=n.e("alertify").then(n.bind(null,287)),Xt=["paths-outer","paths-inner","transfers-outer","station-circles","transfers-inner","dummy-circles"],te=[{event:"routefrom",text:"Route from here"},{event:"routeto",text:"Route to here"},{event:"clearroute",text:"Clear route"},{event:"showheatmap",text:"Show heatmap",extra:{disabled:!0}}];e.default=class{constructor(t){this.mediator=new class{constructor(){this.eventListeners=new Map,this.publish=t=>{console.log("event as seen from the dispatcher",t);const{type:e}=t,n=this.eventListeners.get(e);if(void 0===n||0===n.length)return console.log("no event listeners registered for",e),!1;for(const e of n)e(t);return!0}}subscribe(t,e){const n=this.eventListeners.get(t);void 0===n?this.eventListeners.set(t,[e]):n.push(e)}unsubscribe(t,e){const n=this.eventListeners.get(t);if(void 0===n)return;const s=n.indexOf(e);s<0||n.splice(s,1)}},this.moving=!1,this.contextMenu=new D(te),this.whiskers=new WeakMap,this.platformOffsets=new Map,this.platformsOnSVG=new WeakMap,this.tooltip=new gt,this.config=t,this.makeMap()}getMap(){return this.map}getNetwork(){return this.network}async makeMap(){try{const{config:t}=this,e=this.getGraph(),n=Jt(t.url.scheme),r=$t(t.url.data),i=new Promise(t=>{jt.once("load",t),setTimeout(t,5e3)});t.center=[0,0];const a=Object.assign({},t),c=o.a.control.scale({imperial:!1});this.map=o.a.map(t.containerId,a).addControl(c);const l=this.map.getPanes().mapPane.style;l.visibility="hidden",((t,e)=>{let n=0;addEventListener("keydown",s=>{s.shiftKey&&s.ctrlKey&&76===s.keyCode&&(s.preventDefault(),t.removeLayer(e[n]),++n===e.length&&(n=0),t.addLayer(e[n]),t.invalidateSize(!1))})})(this.map,[jt,_t,Bt,xt,Et,Mt,Ct]),this.addContextMenu();const h=await e;this.network=new G.d(h);const u=this.network.platforms.map(t=>t.location),d=Object(Pt.a)(u);t.center=[d.lat,d.lng];const f=o.a.latLngBounds(u);this.overlay=new class extends class{constructor(t,e){this.onDoubleClick=t=>{this.mousePos=this.map.mouseEventToContainerPoint(t.originalEvent)},this.onZoomAnim=({target:t,center:e,zoom:n})=>{const{map:s}=this,r=s.getZoom();if(n!==r){const i=s.getZoomScale(n,r),a=s.getCenter();e.equals(a)?this.mousePos=o.a.point(innerWidth/2,innerHeight/2).round():this.mousePos||(this.mousePos=k(t,"scrollWheelZoom._lastMousePos")),this.scaleOverlay(i)}this.mousePos=null},this.onZoomEnd=()=>{const{style:t}=this.overlayContainer;t.transform="initial",t.transformOrigin="initial",this.updateOverlayPositioning(),this.map.fireEvent("overlayupdate",this)};const n=O.a.includes(t)&&"svg"!==t?L:j;this.overlayContainer=document.createElementNS(n,t),this.bounds=e}addTo(t){return this.onAdd(t),this}onAdd(t){this.map=t,this.updateOverlayPositioning();const{markerPane:e,mapPane:n}=t.getPanes();n.insertBefore(this.overlayContainer,e),this.addMapMovementListeners()}onRemove(t){t.getPanes().mapPane.removeChild(this.overlayContainer),this.map.clearAllEventListeners()}addMapMovementListeners(){this.overlayContainer.classList.add("leaflet-zoom-animated"),this.map.on("zoomanim",this.onZoomAnim).on("zoomend",this.onZoomEnd).on("dblclick",this.onDoubleClick)}updateOverlayPositioning(){const{map:t,bounds:e}=this,n=e.getNorthWest(),s=e.getSouthEast();this.topLeft=t.project(n,t.getZoom()).round();const r=o.a.bounds(t.latLngToLayerPoint(n),t.latLngToLayerPoint(s)),{style:i}=this.overlayContainer,a=r.min;i.left=a.x+"px",i.top=a.y+"px";const c=r.getSize();i.width=c.x+"px",i.height=c.y+"px"}scaleOverlay(t){const e=this.bounds.getNorthWest(),n=this.map.latLngToContainerPoint(e);if(!this.mousePos){const t=document.documentElement;this.mousePos=o.a.point(t.clientWidth/2,t.clientHeight/2)}const s=this.mousePos.subtract(n),{style:r}=this.overlayContainer;r.transformOrigin=`${s.x}px ${s.y}px`,r.transform=`scale(${t})`}extendBounds(t){this.bounds.extend(t),this.updateOverlayPositioning()}latLngToOverlayPoint(t){return this.map.project(t,this.map.getZoom()).round().subtract(this.topLeft)}}{constructor(t){super("svg",t),this.defs=Object(p.a)("defs"),this.origin=Object(p.a)("g");const{overlayContainer:e}=this;e.classList.add(_.a.overlay),e.appendChild(this.defs),e.appendChild(this.origin)}}(f).addTo(this.map);const{defs:m}=this.overlay;W(m);const{default:g,confirm:b}=await Yt;addEventListener("keydown",async t=>{if(!t.shiftKey||!t.ctrlKey||82!==t.keyCode||!await b("Reset network?"))return;const e=await this.getGraph();this.resetNetwork(e)});const{textContent:y}=m;y||g.alert("\n                    Your browser doesn't seem to have capabilities to display some features of the map.\n                    Consider using Chrome or Firefox for the best experience.\n                "),this.lineRules=await n,this.resetMapView(),this.map.addLayer(jt),this.map.on("overlayupdate",t=>{this.moving=!0,this.redrawNetwork(),this.moving=!1}),this.initNetwork(),this.map.invalidateSize(!1),this.addMapListeners(),(new class{constructor(){this.fromMarker=Object(s.marker)([0,0],{draggable:!0,icon:dt("#228822","A")}),this.toMarker=Object(s.marker)([0,0],{draggable:!0,icon:dt("#dd2222","B")}),this.onFromTo=t=>{const e=this.metroMap.getMap(),n=e.mouseEventToLatLng(t),s="routefrom"===t.type?this.fromMarker:this.toMarker;s.setLatLng(n),e.hasLayer(s)||e.addLayer(s);const o=s===this.fromMarker?this.toMarker:this.fromMarker;e.hasLayer(o)&&this.visualizeShortestRoute(!0)},this.clearRoute=async()=>{const t=this.metroMap.getMap(),e=it();t.removeLayer(this.fromMarker).removeLayer(this.toMarker),(await ft).default.dismissAll(),e.then(S.d)};for(const t of[this.fromMarker,this.toMarker])t.on("drag",t=>this.visualizeShortestRoute(!1)).on("dragend",t=>this.visualizeShortestRoute(!0))}addTo(t){this.metroMap=t;const{mediator:e}=t,n=t.getMap(),s=n.getCenter();return this.fromMarker.setLatLng(s),this.toMarker.setLatLng(s),((t,e)=>{for(const n of e)t.addLayer(n).removeLayer(n)})(n,[this.fromMarker,this.toMarker]),e.subscribe("routefrom",this.onFromTo),e.subscribe("routeto",this.onFromTo),e.subscribe("clearroute",this.clearRoute),n.on("zoomstart",it),addEventListener("keydown",t=>{27===t.keyCode&&e.publish(new Event("clearroute"))}),this}visualizeShortestRoute(t){const e=this.metroMap.getMap();e.hasLayer(this.fromMarker)&&e.hasLayer(this.toMarker)&&this.visualizeRouteBetween(this.fromMarker.getLatLng(),this.toMarker.getLatLng(),t)}async visualizeRouteBetween(t,e,n){Object(S.d)(),(await ft).default.dismissAll(),ut(T(this.metroMap.getNetwork().platforms,t,e),n)}}).addTo(this),(new w).addTo(this.map),r.then(t=>new kt(t).addTo(this.map)),await i,l.visibility="",this.runUnblur()}catch(t){console.error(t)}}runUnblur(){this.map.on("movestart",t=>this.moving=!0).on("moveend",t=>this.moving=!1),Object(r.a)({skipIf:()=>this.moving,interval:250})}subscribe(t,e){this.mediator.subscribe(t,e),this.map.on(t,this.mediator.publish)}addContextMenu(){for(const t of te)this.map.on(t.event,this.mediator.publish);this.contextMenu.addTo(this.map)}addMapListeners(){const{map:t,contextMenu:e}=this;t.on("zoomstart",t=>{this.tooltip.hide()}),t.on("distancemeasureinit",n=>{e.insertItem("measuredistance","Measure distance"),t.on("clearmeasurements",()=>{e.removeItem("clearmeasurements"),e.insertItem("measuredistance","Measure distance")}),this.subscribe("measuredistance",()=>{e.removeItem("measuredistance"),e.insertItem("clearmeasurements","Clear measurements")})})}initNetwork(){const{origin:t}=this.overlay;for(const e of Xt){const n=p.a("g");n.id=e,t.appendChild(n)}t.insertBefore(this.tooltip.element,document.getElementById("dummy-circles")),this.redrawNetwork(),this.addStationListeners()}resetMapView(){const{center:t,zoom:e}=this.config,n={animate:!1};t?(this.map.setView(t,e+1,n),this.map.setView(t,e,n)):console.error("cannot set map to center")}getGraph(){return $t(this.config.url.graph)}resetNetwork(t){this.network=new G.d(t),this.redrawNetwork()}cleanElements(){const{overlay:t,tooltip:e}=this,{element:n}=e;for(const e of t.origin.childNodes)e!==n&&Object(E.d)(e)}redrawNetwork(){console.time("pre"),this.cleanElements(),this.updatePlatformsPositionOnOverlay(),console.timeEnd("pre"),console.time("preparation");const{detailedZoom:t}=this.config,e=this.map.getZoom(),{lineWidth:n,lightLineWidth:s,circleBorder:o,dummyCircleRadius:r,transferWidth:i,transferBorder:c}=this.getSvgSizes(),l={"station-circles":o,"dummy-circles":0,"transfers-outer":i+c/2,"transfers-inner":i-c/2,"paths-outer":n,"paths-inner":n/2},h=new Map;for(const[t,e]of Object.entries(l))h.set(t,document.createDocumentFragment()),Object(E.a)(t).style.strokeWidth=`${e}px`;Object($.c)(this.lineRules,"L").strokeWidth=`${s}px`,this.tooltip.setFontSize(Math.max(.5*(e+10),11));const u=new Map;console.timeEnd("preparation"),console.time("circle preparation");const d=Object($.c)(h,"station-circles"),f=Object($.c)(h,"dummy-circles"),m=e>=t;this.platformOffsets.clear();const g=1*n;for(const t of this.network.spans){const{source:e,target:n,routes:s}=t,o=this.network.spans.filter(t=>t.isOf(e,n));if(1===o.length)continue;if(0===o.length)throw new Error(`some error with span ${e.name}-${n.name}: it probably does not exist`);const r=o.indexOf(t);if(-1===r)throw new Error(`some error with span ${e.name}-${n.name}`);const i=(r-(o.length-1)/2)*g;for(const t of[e,n]){const e=Object($.c)(this.platformsOnSVG,t),n=t.spans.filter(t=>a(t.routes,s).length>0);for(const t of n){Object($.a)(this.platformOffsets,e,()=>new Map).set(t,i)}}}for(const t of this.network.stations){const n=[];for(const n of t.platforms){const t=Object($.c)(this.platformsOnSVG,n),s=this.makeWhiskers(n);if(this.whiskers.set(n,s),e>9){const e=this.makePlatformElement(n);"dummy"===n.type&&(e.style.display="none"),m&&this.colorizePlatformElement(e,n.passingLines());const s=p.c(t,r);d.appendChild(e),V.a.platformBindings.set(n,e),f.appendChild(s),V.a.dummyBindings.set(n,s)}}const s=Gt(this.network,t);if(s.length>0){for(const e of t.platforms)if(s.includes(e)){const t=Object($.c)(this.platformsOnSVG,e);n.push(t)}u.set(t,s)}}console.timeEnd("circle preparation"),console.time("transfer preparation");const b=Object($.c)(h,"transfers-outer"),y=Object($.c)(h,"transfers-inner");for(const t of this.network.transfers){const{source:e,target:n}=t;if(!m&&e.name===n.name)continue;const s=u.get(e.station),o=void 0!==s&&s.includes(e)&&s.includes(n)?this.makeTransferArc(t,s):p.g(Object($.c)(this.platformsOnSVG,e),Object($.c)(this.platformsOnSVG,n));if(V.a.outerEdgeBindings.set(t,o[0]),V.a.innerEdgeBindings.set(t,o[1]),"osi"===t.type){o[1].style.display="none";const t=o[0],e=i/1.5;t.style.strokeDasharray=`${i} ${e}`,t.style.strokeWidth=`${i}px`}else o[0].style.stroke=m?this.makeGradient(t):"#000";b.appendChild(o[0]),y.appendChild(o[1])}console.timeEnd("transfer preparation"),console.time("span preparation");const w=Object($.c)(h,"paths-outer"),v=Object($.c)(h,"paths-inner");for(const t of this.network.spans){const[e,n]=this.makePath(t);w.appendChild(e),n&&v.appendChild(n)}console.timeEnd("span preparation"),console.time("appending");for(const[t,e]of h)Object(E.a)(t).appendChild(e);console.timeEnd("appending")}getSvgSizes(){return h(this.map.getZoom(),this.config.detailedZoom)}makePlatformElement(t){const e=Object($.c)(this.platformsOnSVG,t),{circleRadius:n}=this.getSvgSizes(),s=this.platformOffsets.get(e);if(!s)return p.c(e,n);const o=Array.from(s).map(([t,e])=>e),r=Math.max(...o)-Math.min(...o),i=p.e(e,r,n),{value:a}=Object($.c)(this.whiskers,t).values().next(),c=180*Object(Qt.a)(a.subtract(e),Qt.j)/Math.PI;return i.setAttribute("transform",`rotate(${c})`),i}makeGradient(t){const{source:e,target:n}=t,s=Object($.c)(this.platformsOnSVG,e),o=Object($.c)(this.platformsOnSVG,n),r=[this.getPlatformColor(e),this.getPlatformColor(n)],{fullCircleRadius:i}=this.getSvgSizes(),a=i/s.distanceTo(o),l=o.subtract(s);let h=V.a.gradientBindings.get(t);return void 0===h?((h=Vt(l,r,a)).id=c("gradient-"),V.a.gradientBindings.set(t,h),this.overlay.defs.appendChild(h)):(Zt(h,l),qt(h,a)),`url(#${h.id})`}updatePlatformsPositionOnOverlay(t=this.map.getZoom()){const{config:e,network:n,overlay:s,platformsOnSVG:o}=this;if(t>=e.detailedZoom)for(const t of n.stations)for(const e of t.platforms){const t=s.latLngToOverlayPoint(e.location);o.set(e,t)}else for(const t of n.stations){const e=new Set,n=s.latLngToOverlayPoint(t.getCenter()),{platforms:r}=t;for(const t of r)e.add(t.name),o.set(t,n);if(1===e.size)continue;if(e.size<1)throw console.error(t),new Error("station has no names");const i=new Map;for(const t of e){const e=r.filter(e=>e.name===t).map(t=>t.location),n=Object(Pt.a)(e);i.set(t,s.latLngToOverlayPoint(n))}for(const t of r){const e=Object($.c)(i,t.name);o.set(t,e)}}}getPlatformColor(t){return Rt(this.linesToColors(t.passingLines()))}linesToColors(t){const e=[];for(const n of t){const{stroke:t}=Object($.c)(this.lineRules,"M"===n[0]?n:n[0]);t&&e.push(t)}return e}colorizePlatformElement(t,e){if(0!==e.size)if(1!==e.size)t.style.stroke=Rt(this.linesToColors(e));else{const n=e.values().next().value;t.classList.add("M"===n[0]?n:n[0])}}makeWhiskers(t){const e=Object($.c)(this.platformsOnSVG,t),n=new Map,{spans:s}=t;if(0===s.length)return n;if(1===s.length)return n.set(s[0],e);if(2===s.length){if(2===t.passingLines().size)return n.set(s[0],e).set(s[1],e);const o=s.map(e=>Object($.c)(this.platformsOnSVG,e.other(t))),[r,i]=o,a=Dt.c(r,e,i,1),c=.5*Math.min(e.distanceTo(r),e.distanceTo(i));for(let t=0;t<2;++t){const o=a[t].multiplyBy(c).add(e);n.set(s[t],o)}return n}const o=[[],[]],r=[[],[]],i=new WeakMap;for(const n of s){const s=n.other(t),a=Object($.c)(this.platformsOnSVG,s),c=n.source===t?0:1;o[c].push(Object(Qt.g)(a.subtract(e))),r[c].push(n),i.set(n,e.distanceTo(a))}const[a,c]=o.map(t=>Object(Qt.f)(t).add(e)),l=Dt.c(a,e,c,1);for(let t=0;t<2;++t){const s=l[t];for(const o of r[t]){const t=.5*Object($.c)(i,o),r=s.multiplyBy(t).add(e);n.set(o,r)}}return n}makeTransferArc(t,e){const{network:n,platformsOnSVG:s}=this,{source:o,target:r}=t,a=Object($.c)(s,o),c=Object($.c)(s,r),l=t=>p.f(a,c,Object($.c)(s,t));if(3===e.length){return l(i(e,[o,r])[0])}if(o===e[2]&&r===e[3]||o===e[3]&&r===e[2])return p.g(a,c);const h=[];for(const e of n.transfers)e!==t&&(t.has(e.source)?h.push(e.target):t.has(e.target)&&h.push(e.source));let u;if(2===h.length){if(h[0]!==h[1])throw Error("FFFFUC");u=h[0]}else{if(3!==h.length)throw new Error("111FUUFF");u=h[0]===h[1]?h[2]:h[0]===h[2]?h[1]:h[0]}return l(u)}makePath(t){const{routes:e,source:n,target:s}=t;if(0===e.length)throw console.error(t,"span has no routes!"),new Error("span has no routes!");const o=e[0].line.match(/([MEL])(\d{0,2})/);if(!o)throw new Error(`match failed for ${n.name}-${s.name}`);const[r,i]=o,a=this.getControlPoints(t),c=Object(Ht.a)(a[0],...a.slice(1));if("E"===i){c.classList.add("E");const e=c.cloneNode(!0);return V.a.outerEdgeBindings.set(t,c),V.a.innerEdgeBindings.set(t,e),[c,e]}return void 0!==r&&c.classList.add(r),void 0!==i?c.classList.add(i):c.style.stroke="black",V.a.outerEdgeBindings.set(t,c),[c]}getControlPoints(t){const{source:e,target:n}=t,s=Object($.c)(this.platformsOnSVG,e),o=Object($.c)(this.platformsOnSVG,n),r=[s,Object($.c)(Object($.c)(this.whiskers,e),t),Object($.c)(Object($.c)(this.whiskers,n),t),o],i=this.platformOffsets.get(s),a=this.platformOffsets.get(o);if(i){const e=i.get(t);if(!e)return[r];if(a){const t=Dt.f(r,10),[n,...s]=t.map(t=>Dt.e(t,e));return[n,...s.map(t=>t.slice(1))]}const n=Dt.d(r.slice(0,2),e);return r[0]=n[0],r[1]=n[1],[r]}if(a){const e=a.get(t);if(!e)return[r];const n=Dt.d(r.slice(2,4),e);r[2]=n[0],r[3]=n[1]}return[r]}addStationListeners(){const t=Object(E.a)("dummy-circles");t.addEventListener("mouseover",t=>{const e=t.target,n=Object($.d)(V.a.dummyBindings,e);this.highlightStation(n.station,Object(S.b)(n),[n.name])}),t.addEventListener("mouseout",t=>{this.tooltip.hide(),function(){for(const t of H)Object(E.e)(t,"r");for(const t of Q)Object(E.e)(t,"x","y","width","height","rx","ry");for(const t of U)t.style.strokeWidth="initial";U.clear(),H.clear(),Q.clear(),Q.clear()}()})}highlightStation(t,e,n){const s=t.platforms.filter(t=>n.includes(t.name));for(const t of s){K(Object($.c)(V.a.platformBindings,t),1.25,!0)}if(this.map.getZoom()>=this.config.detailedZoom)for(const t of this.network.transfers){s.some(e=>t.has(e))&&n.includes(t.source.name)&&n.includes(t.target.name)&&J(t,1.25)}const o=l(s,t=>t.location.lat),r=Object($.c)(V.a.platformBindings,o);s.some(t=>"dummy"!==t.type)&&this.tooltip.show(p.b(r),e)}}},7:function(t,e,n){"use strict";n.d(e,"b",(function(){return c})),n.d(e,"f",(function(){return u})),n.d(e,"d",(function(){return d})),n.d(e,"e",(function(){return f})),n.d(e,"c",(function(){return p})),n.d(e,"a",(function(){return m}));var s=n(0),o=n(96),r=n(9),i=n(4);const a=t=>t>0&&Number.isInteger(t),c=t=>Math.abs(t)<=Number.EPSILON,l=(t,e)=>h(((t,e)=>t.slice(1).map((n,s)=>((t,e,n)=>e.subtract(t).multiplyBy(n).add(t))(t[s],n,e)))(t,e),e),h=(t,e)=>t.length<2?t:[o(t),...l(t,e),r(t)];function u(t,e){if(!a(e))throw new Error(`k must be a natural number, got ${e} instead`);if(1===e)return[t];const[n,s]=function(t,e){const n=h(t,e),s=n.length>>1;return[n.slice(0,s+1),n.slice(s)]}(t,1/e);return[n,...u(s,e-1)]}function d(t,e){if(2!==t.length)throw new Error("line must have 2 points");if(t[0].equals(t[1]))throw new Error("points are overlapped");const n=t[1].subtract(t[0]),[s]=Object(i.h)(n),o=Object(i.g)(s).multiplyBy(e);return t.map(t=>t.add(o))}function f(t,e){if(t.length<2)throw new Error("there should be at least 2 control points for an offset");return t.map((n,s)=>{const o=t[s-1],r=t[s+1];if(!o)return d([n,r],e)[0];if(!r)return d([o,n],e)[1];const[a,c]=d([o,n],e),[l]=d([r,n],-e),h=o.subtract(n),u=r.subtract(n);return Object(i.e)([a,h],[l,u])||c})}function p(t,e,n,s=1){const o=t.subtract(e),r=n.subtract(e),a=Object(i.b)(o,r),c=Object(i.c)(o,r)<0?-s:s;return Object(i.h)(a.multiplyBy(c))}function m(t){if(3!==t.length)throw new Error("must have 3 vertices");const e=t[0],n=t[1].subtract(e),o=t[2].subtract(e),r=Object(i.d)(n,n),a=Object(i.d)(o,o),c=Object(i.c)(n,o);return Math.abs(c)<Number.EPSILON?null:Object(s.point)(o.y*r-n.y*a,n.x*a-o.x*r).divideBy(2*c).add(e)}},87:function(t,e,n){"use strict";var s=n(11);const o={spb:"fi",qazan:"tt",helsinki:"se"};e.a=()=>{const t=Object(s.a)();return o[t]}},91:function(t,e,n){"use strict";n.d(e,"b",(function(){return i})),n.d(e,"a",(function(){return a}));n(0);var s=n(2);const o=["","L","Q","C"];function r(t){const{length:e}=t;if(e>3)throw new Error(`the tail should consist of 1-3 elements, but got ${e} instead`);return`${o[e]} ${t.map(t=>`${t.x} ${t.y}`).join(" ")}`}function i(t,e,...n){if(e.length<2)throw new Error(`there should be at least 2 control points, but got ${e.length} instead`);const[s,...o]=e;n.unshift(o);const i=n.map(r).join(" ");t.setAttribute("d",`M ${s.x} ${s.y} ${i}`)}function a(t,...e){const n=Object(s.a)("path");return i(n,t,...e),n}},97:function(t,e,n){t.exports={"dashed-line":"src-ui-DistanceMeasure-___styles__dashed-line___1ueOJ"}},99:function(t,e,n){t.exports={overlay:"src-ui-SvgOverlay-___styles__overlay___3iycs"}}},[[112,"runtime~app","lodash","leaflet","vendor"]]]);