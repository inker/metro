!function t(e,n,r){function a(i,s){if(!n[i]){if(!e[i]){var u="function"==typeof require&&require;if(!s&&u)return u(i,!0);if(o)return o(i,!0);var l=new Error("Cannot find module '"+i+"'");throw l.code="MODULE_NOT_FOUND",l}var c=n[i]={exports:{}};e[i][0].call(c.exports,function(t){var n=e[i][1][t];return a(n?n:t)},c,c.exports,t,e,n,r)}return n[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)a(r[i]);return a}({1:[function(t,e,n){"use strict";var r=function(){function t(t,e,n){var r=L.control.UniForm(e,n||null,{collapsed:!1,position:"topright"});r.addTo(t.getMap()),r.renderUniformControl()}return t}();n.LayerControl=r;var a=function(){function t(t){var e=t.getOverlay(),n=t.getMap(),r=new L.Polyline([],{color:"red"});r.addTo(n);var a=new L.CircleMarker([60,30]);e.addEventListener("click",function(t){if(t.shiftKey){var e=n.containerPointToLatLng(new L.Point(t.x,t.y));r.addLatLng(e).redraw(),a.on("mouseout",function(t){return a.closePopup()}),a.addTo(n);var o=r.getLatLngs();if(o.length>1){for(var i=0,s=1;s<o.length;++s)i+=o[s-1].distanceTo(o[s]);L.popup().setLatLng(e).setContent("Popup").openOn(n)}}})}return t}();n.Measurement=a},{}],2:[function(t,e,n){"use strict";{var r=t("./metro-map"),a=function(){return new L.TileLayer("https://{s}.tiles.mapbox.com/v3/inker.mlo91c41/{z}/{x}/{y}.png",{minZoom:9,id:"inker.mlo91c41",bounds:null,attribution:'Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://mapbox.com">Mapbox</a>'})}(),o=function(){return new L.TileLayer("http://openmapsurfer.uni-hd.de/tiles/roads/x={x}&y={y}&z={z}",{minZoom:9,attribution:'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'})}();new r("map-container","json/graph.json",{Mapbox:a,OpenMapSurfer:o})}!function(){var t=["Plan metro Sankt-Peterburga","Pietarin metron hankesuunnitelma","St Petersburg metro plan proposal"],e=0;setInterval(function(){return document.title=t[++e%t.length]},3e3)}(),console.log("user: "+navigator.userLanguage),console.log("language: "+navigator.language),console.log("browser: "+navigator.browserLanguage),console.log("system: "+navigator.systemLanguage)},{"./metro-map":3}],3:[function(t,e,n){"use strict";var r=window.L,a=t("./svg"),o=t("./util"),i=t("./addons"),s=function(){function t(t,e,n){var a=this,o=this.fetch(e),s=this.fetch("json/hints.json");this.map=new r.Map(t,{layers:n.Mapbox||n[Object.keys(n).toString()],center:new r.LatLng(60,30),zoom:11,minZoom:9,inertia:!0}).addControl(new r.Control.Scale({imperial:!1})),new i.LayerControl(this,n),console.log("map should be created by now"),this.addOverlay(),this.addListeners(),o.then(function(t){return a.handleJSON(t)}).then(function(){return s}).then(function(t){return a.appendHintsToGraph(t)}).then(function(){return a.redrawNetwork()})["catch"](function(t){return alert(t)})}return t.prototype.getMap=function(){return this.map},t.prototype.getOverlay=function(){return this.overlay},t.prototype.addOverlay=function(){this.overlay=document.getElementById("overlay"),this.overlay.id="overlay",this.overlay.style.fill="white",this.overlay.style.zIndex="10"},t.prototype.addListeners=function(){var t=this,e=this.map.getPanes().mapPane;this.map.on("movestart",function(e){return t.map.touchZoom.disable()}),this.map.on("move",function(n){t.overlay.style["-webkit-transition"]=e.style["-webkit-transition"],t.overlay.style.transition=e.style.transition,t.overlay.style.transform=e.style.transform}),this.map.on("moveend",function(n){t.map.touchZoom.enable(),t.overlay.style["-webkit-transition"]=null,t.overlay.style.transition=null;var r=o.parseTransform(e.style.transform);t.overlay.style.transform=e.style.transform="translate("+r.x+"px, "+r.y+"px)"}),this.map.on("zoomstart",function(e){t.map.dragging.disable(),t.overlay.style.opacity="0.5"}),this.map.on("zoomend",function(e){t.redrawNetwork(),t.overlay.style.opacity=null,t.map.dragging.enable()})},t.prototype.fetch=function(t){return new Promise(function(e,n){var r=new XMLHttpRequest;r.onreadystatechange=function(){4===r.readyState&&(200===r.status?e(r.responseText):n("couldn't fetch "+t+": "+r.status+": "+r.statusText))},r.open("GET",t,!0),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.send()})},t.prototype.handleJSON=function(t){this.graph=JSON.parse(t),this.extendBounds(),this.map.setView(this.bounds.getCenter(),11,{pan:{animate:!1},zoom:{animate:!1}})},t.prototype.appendHintsToGraph=function(t){this.graph.hints=JSON.parse(t),console.log(this.graph.hints)},t.prototype.refillSVG=function(){for(var t=void 0;t=this.overlay.firstChild;)this.overlay.removeChild(t);var e=a.createSVGElement("defs");e.id="defs",e.appendChild(a.makeDropShadow()),this.overlay.appendChild(e);var n=a.createSVGElement("g");n.id="origin",["paths","transfers","station-circles","dummy-circles"].forEach(function(t){var e=a.createSVGElement("g");e.id=t,n.appendChild(e)}),this.overlay.appendChild(n);var r=document.getElementById("station-circles");r.classList.add("station-circle"),n.insertBefore(a.makePlate(),r.nextElementSibling)},t.prototype.extendBounds=function(){var t=this,e=this.graph.platforms[0].location;this.bounds=new r.LatLngBounds(e,e),this.graph.platforms.forEach(function(e){return t.bounds.extend(e.location)})},t.prototype.showPlate=function(t){var e=t.target,n=o.getSVGDataset(e),r=document.getElementById(n.platformId||n.stationId),i=a.changePlate(r);i.style.display=null},t.prototype.posOnSVG=function(t,e){var n=this.map.latLngToContainerPoint(e);return n.subtract(t.min)},t.prototype.updatePos=function(){var t=this.bounds.getNorthWest(),e=this.bounds.getSouthEast(),n=new r.Bounds(this.map.latLngToContainerPoint(t),this.map.latLngToContainerPoint(e)),a=o.parseTransform(this.overlay.style.transform),i=n.getSize(),s=n.min.subtract(a).subtract(i);this.overlay.style.left=s.x+"px",this.overlay.style.top=s.y+"px";var u=i,l=document.getElementById("origin");l.style.transform="translate("+u.x+"px, "+u.y+"px)";var c=i.multiplyBy(3);this.overlay.style.width=c.x+"px",this.overlay.style.height=c.y+"px"},t.prototype.redrawNetwork=function(){var t=this,e=this;this.refillSVG(),this.updatePos();for(var n={"station-circles":document.createDocumentFragment(),"dummy-circles":document.createDocumentFragment(),transfers:document.createDocumentFragment(),paths:document.createDocumentFragment()},i=document.getElementById("station-plate"),s=new Array(this.graph.platforms.length),u=this.map.getZoom(),l=this.bounds.getNorthWest(),c=this.bounds.getSouthEast(),p=new r.Bounds(this.map.latLngToContainerPoint(l),this.map.latLngToContainerPoint(c)),d=12>u?function(t){return e.posOnSVG(p,e.graph.stations[t.station].location)}:function(t){return e.posOnSVG(p,t.location)},h=this.graph.platforms.map(d),g=.5*(u-7),f=12>u?1.25*g:g,m=.4*f,y=g,v=new Set,b=function(r){var l=t.graph.stations[r],c=o.findCircle(t.graph,l),p=[];if(l.platforms.forEach(function(t){var o=e.graph.platforms[t],l=h[t];if(u>9){var d=a.makeCircle(l,f);a.convertToStation(d,"p-"+t,o,m),d.setAttribute("data-station",r.toString());var g=a.makeCircle(l,2*f);g.classList.add("invisible-circle"),g.setAttribute("data-platformId",d.id),g.onmouseover=e.showPlate,g.onmouseout=function(t){return i.style.display="none"},n["station-circles"].appendChild(d),n["dummy-circles"].appendChild(g)}if(2===o.spans.length)!function(){var n=[l,l],r=[0,0],a=e.graph.spans[o.spans[0]];a.source===t&&o.spans.reverse();for(var i=0;2>i;++i){var u=e.graph.spans[o.spans[i]],c=u.source===t?u.target:u.source,p=(e.graph.platforms[c],h[c]);r[i]=l.distanceTo(p),n[i]=l.add(p).divideBy(2)}var d=n[1].subtract(n[0]).multiplyBy(r[0]/(r[0]+r[1])),g=n[0].add(d),f=l.subtract(g);s[t]=n.map(function(t){return t.add(f)})}();else if(3===o.spans.length){for(var y=[],b=[],x=0;3>x;++x){var w=e.graph.spans[o.spans[x]];if(w.source===t){var S=(e.graph.platforms[w.target],h[w.target]);y.push(S)}else{var S=(e.graph.platforms[w.source],h[w.source]);b.push(S)}}var L=1===b.length?b[0]:b[0].add(b[1]).divideBy(2),C=1===y.length?y[0]:y[0].add(y[1]).divideBy(2),k=l.distanceTo(L),A=l.distanceTo(C),E=l.add(L).divideBy(2),P=l.add(C).divideBy(2),T=P.subtract(E).multiplyBy(k/(k+A)),B=E.add(T),O=l.subtract(B);s[t]=[E.add(O),P.add(O)]}else s[t]=[l,l];c&&c.indexOf(o)>-1&&(p.push(l),v.add(t))}),u>11&&c){var d=o.getCircumcenter(p),g=d.distanceTo(p[0]),b=a.makeRingWithBorders(d,g,y,m);n.transfers.appendChild(b)}},x=0;x<this.graph.stations.length;++x)b(x);u>11&&this.graph.transfers.forEach(function(t){if(!v.has(t.source)||!v.has(t.target)){var r=e.graph.platforms[t.source],o=e.graph.platforms[t.target],i=[e.posOnSVG(p,r.location),e.posOnSVG(p,o.location)],s=a.makeTransfer(i[0],i[1],y,m);n.transfers.appendChild(s)}});for(var w=0;w<this.graph.spans.length;++w){var S=this.graph.spans[w],L=S.source,C=S.target,k=(this.graph.platforms[L],this.graph.platforms[C],a.makeCubicBezier([h[L],s[L][1],s[C][0],h[C]])),A=S.routes.map(function(t){return e.graph.routes[t]}),E=A[0].line.match(/[MEL](\d{1,2})/);k.style.strokeWidth=g.toString(),E&&k.classList.add(E[0]),k.classList.add(A[0].line.charAt(0)+"-line"),n.paths.appendChild(k)}Object.keys(n).forEach(function(t){return document.getElementById(t).appendChild(n[t])})},t}();e.exports=s},{"./addons":1,"./svg":4,"./util":5}],4:[function(t,e,n){"use strict";function r(t,e){var n=u("circle");return n.setAttribute("r",e.toString()),n.setAttribute("cy",t.y.toString()),n.setAttribute("cx",t.x.toString()),n}function a(t,e,n,r){t.id=e,t.style.strokeWidth=r+"px",g.setSVGDataset(t,{lat:n.location.lat,lng:n.location.lng,ru:n.name,fi:n.altName})}function o(t){if(4!==t.length)throw new Error("there should be 4 points");var e=u("path"),n=t.map(function(t){return t.x+","+t.y});return n.unshift("M"),n.splice(2,0,"C"),e.setAttribute("d",n.join(" ")),e}function i(t,e,n,a){var o=u("g");o.classList.add("transfer");var i=.5*a;return[n+i,n-i].forEach(function(n){var a=r(t,e);a.style.strokeWidth=n+"px",o.appendChild(a)}),o}function s(t,e,n,r){var a=u("g");a.classList.add("transfer");var o=.5*r;return[n+o,n-o].forEach(function(n){var r=u("line");r.setAttribute("x1",t.x.toString()),r.setAttribute("y1",t.y.toString()),r.setAttribute("x2",e.x.toString()),r.setAttribute("y2",e.y.toString()),r.style.strokeWidth=n+"px",a.appendChild(r)}),a}function u(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function l(){var t=u("filter");return t.id="shadow",t.setAttribute("width","200%"),t.setAttribute("height","200%"),t.innerHTML='\n        <feOffset result="offOut" in="SourceAlpha" dx="0" dy="2" />\n        <feGaussianBlur result="blurOut" in="offOut" stdDeviation="2" />\n        <feBlend in="SourceGraphic" in2="blurOut" mode="normal" />\n    ',t}function c(){var t=u("g");return t.id="station-plate",t.style.display="none",t.innerHTML='<line id="pole" class="plate-pole"/>\n            <g>\n                <rect id="plate-box" class="plate-box" filter="url(#shadow)"/>\n                <text id="plate-text" fill="black" class="plate-text"><tspan/><tspan/><tspan/></text>\n            </g>',t}function p(t){var e=document.getElementById("station-plate"),n=new h.Point(Number(t.getAttribute("cx")),Number(t.getAttribute("cy"))),r=Number(t.getAttribute("r")),a=Math.trunc(r),o=e.children[0],i=new h.Point(4+a,8+a),s=n.subtract(i);o.setAttribute("x1",n.x.toString()),o.setAttribute("y1",n.y.toString()),o.setAttribute("x2",s.x.toString()),o.setAttribute("y2",s.y.toString());var u=g.getSVGDataset(t),l=u.ru,c=u.fi,p=c?"fi"===g.getUserLanguage()?[c,l]:[l,c]:[l];return l in g.englishStationNames&&p.push(g.englishStationNames[l]),d(s,p),e}function d(t,e){var n=document.getElementById("plate-box"),r=12,a=e.reduce(function(t,e){return t.length<e.length?e:t}),o=new h.Point(10+6*a.length,6+r*e.length);n.setAttribute("width",o.x.toString()),n.setAttribute("height",o.y.toString());var i=t.subtract(o);n.setAttribute("x",i.x.toString()),n.setAttribute("y",i.y.toString());for(var s=document.getElementById("plate-text"),u=0;u<e.length;++u){var l=t.subtract(new h.Point(3,o.y-(u+1)*r)),c=s.children[u];c.setAttribute("x",l.x.toString()),c.setAttribute("y",l.y.toString()),c.textContent=e[u]}for(;u<s.children.length;++u)s.children[u].textContent=null}var h=window.L,g=t("./util");n.makeCircle=r,n.convertToStation=a,n.makeCubicBezier=o,n.makeRingWithBorders=i,n.makeTransfer=s,n.createSVGElement=u,n.makeDropShadow=l,n.makePlate=c,n.changePlate=p},{"./util":5}],5:[function(t,e,n){"use strict";function r(){return(navigator.userLanguage||navigator.language).slice(0,2).toLowerCase()}function a(t){var e=t.match(/translate(3d)?\((-?\d+).*?,\s?(-?\d+).*?(,\s?(-?\d+).*?)?\)/i);return e?new p.Point(Number(e[2]),Number(e[3])):new p.Point(0,0)}function o(t,e){if(3!==e.platforms.length)return null;var n=e.platforms.map(function(e){return t.platforms[e]});return n.every(function(t){return 2===t.transfers.length})?n:null}function i(t){if(3!==t.length)throw new Error("must have 3 vertices");console.log(t[1]);var e=t[1].subtract(t[0]),n=t[2].subtract(t[0]),r=e.x*e.x+e.y*e.y,a=n.x*n.x+n.y*n.y;return new p.Point(n.y*r-e.y*a,e.x*a-n.x*r).divideBy(2*(e.x*n.y-e.y*n.x)).add(t[0])}function s(t){if(t.dataset)return t.dataset;for(var e=t.attributes,n={},r=0;r<e.length;++r){var a=e[r].name;a.startsWith("data-")&&(n[a.slice(5)]=t.getAttribute(a))}return n}function u(t,e){Object.keys(e).forEach(function(n){return t.setAttribute("data-"+n,e[n])})}function l(t,e){return t.x*e.x+t.y*e.y}function c(t,e){return l(t,e)/t.distanceTo(e)}var p=window.L;n.getUserLanguage=r,n.parseTransform=a,n.findCircle=o,n.getCircumcenter=i,n.getSVGDataset=s,n.setSVGDataset=u,n.englishStationNames={"Centraľnyj voxal":"Central Raiway Station",Aeroport:"Airport"},n.dot=l,n.angle=c},{}]},{},[2]);